<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyapprox.analysis.sensitivity_analysis &mdash; PyApprox 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyApprox
            <img src="../../../_static/pyapprox-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Software Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_tutorials/index.html">Theoretical Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Benchmarks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmarks.html">Benchmarks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Reference Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_reference_guide.html">User Reference Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyApprox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>pyapprox.analysis.sensitivity_analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyapprox.analysis.sensitivity_analysis</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">OptimizeResult</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">pyapprox.surrogates.interp.indexing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">hash_array</span><span class="p">,</span> <span class="n">argsort_indices_leixographically</span><span class="p">,</span> <span class="n">compute_hyperbolic_indices</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyapprox.util.utilities</span> <span class="kn">import</span> <span class="n">nchoosek</span>
<span class="kn">from</span> <span class="nn">pyapprox.expdesign.low_discrepancy_sequences</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">sobol_sequence</span><span class="p">,</span> <span class="n">halton_sequence</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyapprox.variables.sampling</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">generate_independent_random_samples</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyapprox.surrogates.gaussianprocess.gaussian_process</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_compute_expected_sobol_indices</span><span class="p">,</span> <span class="n">generate_gp_realizations</span><span class="p">,</span>
    <span class="n">extract_gaussian_process_attributes_for_integration</span><span class="p">,</span> <span class="n">GaussianProcess</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyapprox.surrogates.polychaos.gpc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">define_poly_options_from_variable_transformation</span><span class="p">,</span> <span class="n">PolynomialChaosExpansion</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyapprox.surrogates.polychaos.sparse_grid_to_gpc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">convert_sparse_grid_to_polynomial_chaos_expansion</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_main_and_total_effect_indices_from_pce</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assume basis is orthonormal</span>
<span class="sd">    Assume first coefficient is the coefficient of the constant basis. Remove</span>
<span class="sd">    this assumption by extracting array index of constant term from indices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    main_effects : np.ndarray(num_vars)</span>
<span class="sd">        Contribution to variance of each variable acting alone</span>

<span class="sd">    total_effects : np.ndarray(num_vars)</span>
<span class="sd">        Contribution to variance of each variable acting alone or with</span>
<span class="sd">        other variables</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_vars</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_terms</span><span class="p">,</span> <span class="n">num_qoi</span> <span class="o">=</span> <span class="n">coefficients</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">num_terms</span> <span class="o">==</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">main_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_vars</span><span class="p">,</span> <span class="n">num_qoi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">total_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_vars</span><span class="p">,</span> <span class="n">num_qoi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_qoi</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_terms</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span>

        <span class="c1"># calculate contribution to variance of the index</span>
        <span class="n">var_contribution</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># get number of dimensions involved in interaction, also known</span>
        <span class="c1"># as order</span>
        <span class="n">non_constant_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">non_constant_vars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">variance</span> <span class="o">+=</span> <span class="n">var_contribution</span>

        <span class="c1"># update main effects</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">non_constant_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">main_effects</span><span class="p">[</span><span class="n">var</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">var_contribution</span>

        <span class="c1"># update total effects</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">non_constant_vars</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">total_effects</span><span class="p">[</span><span class="n">var</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">var_contribution</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">variance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">main_effects</span> <span class="o">/=</span> <span class="n">variance</span>
    <span class="n">total_effects</span> <span class="o">/=</span> <span class="n">variance</span>
    <span class="k">return</span> <span class="n">main_effects</span><span class="p">,</span> <span class="n">total_effects</span>


<span class="k">def</span> <span class="nf">get_sobol_indices</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">num_terms</span><span class="p">,</span> <span class="n">num_qoi</span> <span class="o">=</span> <span class="n">coefficients</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_qoi</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">num_terms</span> <span class="o">==</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">interactions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">interaction_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kk</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_terms</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span>
        <span class="n">var_contribution</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">non_constant_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">hash_array</span><span class="p">(</span><span class="n">non_constant_vars</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_constant_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">variance</span> <span class="o">+=</span> <span class="n">var_contribution</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_constant_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_constant_vars</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_order</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">:</span>
                <span class="n">interaction_values</span><span class="p">[</span><span class="n">interactions</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">var_contribution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interactions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kk</span>
                <span class="n">interaction_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_contribution</span><span class="p">)</span>
                <span class="n">interaction_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">non_constant_vars</span><span class="p">)</span>
                <span class="n">kk</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># interaction_terms = np.asarray(interaction_terms).T</span>
    <span class="n">interaction_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">interaction_values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">interaction_values</span><span class="o">/</span><span class="n">variance</span>


<div class="viewcode-block" id="plot_main_effects"><a class="viewcode-back" href="../../../api/pyapprox.analysis.plot_main_effects.html#pyapprox.analysis.plot_main_effects">[docs]</a><span class="k">def</span> <span class="nf">plot_main_effects</span><span class="p">(</span><span class="n">main_effects</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">truncation_pct</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                      <span class="n">max_slices</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">rv</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">qoi</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the main effects in a pie chart showing relative size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    main_effects : np.ndarray (nvars,nqoi)</span>
<span class="sd">        The variance based main effect sensitivity indices</span>

<span class="sd">    ax : :class:`matplotlib.pyplot.axes.Axes`</span>
<span class="sd">        Axes that will be used for plotting</span>

<span class="sd">    truncation_pct : float</span>
<span class="sd">        The proportion :math:`0&lt;p\le 1` of the sensitivity indices</span>
<span class="sd">        effects to plot</span>

<span class="sd">    max_slices : integer</span>
<span class="sd">        The maximum number of slices in the pie-chart. Will only</span>
<span class="sd">        be active if the turncation_pct gives more than max_slices</span>

<span class="sd">    rv : string</span>
<span class="sd">        The name of the random variables when creating labels</span>

<span class="sd">    qoi : integer</span>
<span class="sd">        The index 0&lt;qoi&lt;nqoi of the quantitiy of interest to plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">main_effects</span> <span class="o">=</span> <span class="n">main_effects</span><span class="p">[:,</span> <span class="n">qoi</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">main_effects</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="n">main_effects_sum</span> <span class="o">=</span> <span class="n">main_effects</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># sort main_effects in descending order</span>
    <span class="n">II</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">main_effects</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">main_effects</span> <span class="o">=</span> <span class="n">main_effects</span><span class="p">[</span><span class="n">II</span><span class="p">]</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">partial_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">II</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">partial_sum</span><span class="o">/</span><span class="n">main_effects_sum</span> <span class="o">&lt;</span> <span class="n">truncation_pct</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_slices</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">II</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">partial_sum</span> <span class="o">+=</span> <span class="n">main_effects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">main_effects</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">partial_sum</span> <span class="o">-</span> <span class="n">main_effects_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">explode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">main_effects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{other}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">main_effects</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_effects_sum</span> <span class="o">-</span> <span class="n">partial_sum</span>
        <span class="n">explode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">main_effects</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">explode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">main_effects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">main_effects</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="n">explode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>


<span class="k">def</span> <span class="nf">plot_sensitivity_indices_with_confidence_intervals</span><span class="p">(</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">sa_indices_median</span><span class="p">,</span> <span class="n">sa_indices_q1</span><span class="p">,</span> <span class="n">sa_indices_q3</span><span class="p">,</span>
        <span class="n">sa_indices_min</span><span class="p">,</span> <span class="n">sa_indices_max</span><span class="p">,</span> <span class="n">reference_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fliers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">nindices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sa_indices_median</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">nindices</span>
    <span class="k">if</span> <span class="n">reference_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">nindices</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nindices</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nindices</span><span class="p">):</span>
        <span class="c1"># use boxplot stats mean entry to store reference values.</span>
        <span class="k">if</span> <span class="n">reference_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_values</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;med&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa_indices_median</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;q1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa_indices_q1</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;q3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa_indices_q3</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="c1"># use whiskers for min and max instead of fliers</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;whislo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa_indices_min</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;whishi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa_indices_max</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="s1">&#39;fliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fliers</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">reference_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">showmeans</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">showmeans</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">fliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">showfliers</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">showfliers</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">bp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bxp</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">showfliers</span><span class="o">=</span><span class="n">showfliers</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="n">showmeans</span><span class="p">,</span>
                <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                               <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
                <span class="n">medianprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nindices</span>
    <span class="k">for</span> <span class="n">patch</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">],</span> <span class="n">colors</span><span class="p">):</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">nindices</span>
    <span class="k">return</span> <span class="n">bp</span>


<div class="viewcode-block" id="plot_total_effects"><a class="viewcode-back" href="../../../api/pyapprox.analysis.plot_total_effects.html#pyapprox.analysis.plot_total_effects">[docs]</a><span class="k">def</span> <span class="nf">plot_total_effects</span><span class="p">(</span><span class="n">total_effects</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">truncation_pct</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                       <span class="n">rv</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">qoi</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the total effects in a bar chart showing relative size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    total_effects : np.ndarray (nvars,nqoi)</span>
<span class="sd">        The variance based total effect sensitivity indices</span>

<span class="sd">    ax : :class:`matplotlib.pyplot.axes.Axes`</span>
<span class="sd">        Axes that will be used for plotting</span>

<span class="sd">    truncation_pct : float</span>
<span class="sd">        The proportion :math:`0&lt;p\le 1` of the sensitivity indices</span>
<span class="sd">        effects to plot</span>

<span class="sd">    rv : string</span>
<span class="sd">        The name of the random variables when creating labels</span>

<span class="sd">    qoi : integer</span>
<span class="sd">        The index 0&lt;qoi&lt;nqoi of the quantitiy of interest to plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">total_effects</span> <span class="o">=</span> <span class="n">total_effects</span><span class="p">[:,</span> <span class="n">qoi</span><span class="p">]</span>

    <span class="n">width</span> <span class="o">=</span> <span class="mf">.95</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_effects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">locations</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">total_effects</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_effects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="plot_interaction_values"><a class="viewcode-back" href="../../../api/pyapprox.analysis.plot_interaction_values.html#pyapprox.analysis.plot_interaction_values">[docs]</a><span class="k">def</span> <span class="nf">plot_interaction_values</span><span class="p">(</span><span class="n">interaction_values</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
                            <span class="n">truncation_pct</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">max_slices</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">rv</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">qoi</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot sobol indices in a pie chart showing relative size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interaction_values : np.ndarray (nvars,nqoi)</span>
<span class="sd">        The variance based Sobol indices</span>

<span class="sd">    interaction_terms : nlist (nchoosek(nvars+max_order,nvars))</span>
<span class="sd">        Indices np.ndarrays of varying size specifying the variables in each</span>
<span class="sd">        interaction in ``interaction_indices``</span>

<span class="sd">    ax : :class:`matplotlib.pyplot.axes.Axes`</span>
<span class="sd">        Axes that will be used for plotting</span>

<span class="sd">    truncation_pct : float</span>
<span class="sd">        The proportion :math:`0&lt;p\le 1` of the sensitivity indices</span>
<span class="sd">        effects to plot</span>

<span class="sd">    max_slices : integer</span>
<span class="sd">        The maximum number of slices in the pie-chart. Will only</span>
<span class="sd">        be active if the turncation_pct gives more than max_slices</span>

<span class="sd">    rv : string</span>
<span class="sd">        The name of the random variables when creating labels</span>

<span class="sd">    qoi : integer</span>
<span class="sd">        The index 0&lt;qoi&lt;nqoi of the quantitiy of interest to plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">interaction_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction_terms</span><span class="p">)</span>
    <span class="n">interaction_values</span> <span class="o">=</span> <span class="n">interaction_values</span><span class="p">[:,</span> <span class="n">qoi</span><span class="p">]</span>

    <span class="n">II</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">interaction_values</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">interaction_values</span> <span class="o">=</span> <span class="n">interaction_values</span><span class="p">[</span><span class="n">II</span><span class="p">]</span>
    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">interaction_terms</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">II</span><span class="p">]</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">partial_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">interaction_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">partial_sum</span> <span class="o">&lt;</span> <span class="n">truncation_pct</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_slices</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;($&#39;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction_terms</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">},&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">}$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">partial_sum</span> <span class="o">+=</span> <span class="n">interaction_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">interaction_values</span> <span class="o">=</span> <span class="n">interaction_values</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">partial_sum</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">:</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{other}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">interaction_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">interaction_values</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="o">-</span><span class="n">partial_sum</span><span class="p">]])</span>

    <span class="n">explode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">interaction_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">explode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">assert</span> <span class="n">interaction_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">interaction_values</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="n">explode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>


<span class="k">def</span> <span class="nf">get_morris_trajectory</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a morris trajectory used to compute elementary effects</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nvars : integer</span>
<span class="sd">        The number of variables</span>

<span class="sd">    nlevels : integer</span>
<span class="sd">        The number of levels used for to define the morris grid.</span>

<span class="sd">    eps : float</span>
<span class="sd">        Set grid used defining the morris trajectory to [eps,1-eps].</span>
<span class="sd">        This is needed when mapping the morris trajectories using inverse</span>
<span class="sd">        CDFs of unbounded variables</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trajectory : np.ndarray (nvars,nvars+1)</span>
<span class="sd">        The Morris trajectory which consists of nvars+1 samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">nlevels</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">nlevels</span><span class="o">/</span><span class="p">((</span><span class="n">nlevels</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">samples_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">)</span>

    <span class="n">initial_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">samples_1d</span><span class="p">,</span> <span class="n">nvars</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="p">],</span> <span class="n">nvars</span><span class="p">))</span>
    <span class="n">trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_point</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
        <span class="n">trajectory</span><span class="p">[:,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trajectory</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trajectory</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">delta</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trajectory</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This should not happen&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trajectory</span>


<span class="k">def</span> <span class="nf">get_morris_samples</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">,</span> <span class="n">ntrajectories</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">icdfs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a set of Morris trajectories used to compute elementary effects</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The choice of nlevels must be linked to the choice of ntrajectories.</span>
<span class="sd">    For example, if a large number of possible levels is used ntrajectories</span>
<span class="sd">    must also be high, otherwise if ntrajectories is small effort will be</span>
<span class="sd">    wasted because many levels will not be explored. nlevels=4 and</span>
<span class="sd">    ntrajectories=10 is often considered reasonable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nvars : integer</span>
<span class="sd">        The number of variables</span>

<span class="sd">    nlevels : integer</span>
<span class="sd">        The number of levels used for to define the morris grid.</span>

<span class="sd">    ntrajectories : integer</span>
<span class="sd">        The number of Morris trajectories requested</span>

<span class="sd">    eps : float</span>
<span class="sd">        Set grid used defining the Morris trajectory to [eps,1-eps].</span>
<span class="sd">        This is needed when mapping the morris trajectories using inverse</span>
<span class="sd">        CDFs of unbounded variables</span>

<span class="sd">    icdfs : list (nvars)</span>
<span class="sd">        List of inverse CDFs functions for each variable</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    trajectories : np.ndarray (nvars,ntrajectories*(nvars+1))</span>
<span class="sd">        The Morris trajectories</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">icdfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">icdfs</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">]</span><span class="o">*</span><span class="n">nvars</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">icdfs</span><span class="p">)</span> <span class="o">==</span> <span class="n">nvars</span>

    <span class="n">trajectories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">get_morris_trajectory</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntrajectories</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
        <span class="n">trajectories</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">icdfs</span><span class="p">[</span><span class="n">ii</span><span class="p">](</span><span class="n">trajectories</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">return</span> <span class="n">trajectories</span>


<span class="k">def</span> <span class="nf">get_morris_elementary_effects</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the Morris elementary effects from a set of trajectories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    samples : np.ndarray (nvars,ntrajectories*(nvars+1))</span>
<span class="sd">        The morris trajectories</span>

<span class="sd">    values : np.ndarray (ntrajectories*(nvars+1),nqoi)</span>
<span class="sd">        The values of the vecto-valued target function with nqoi quantities</span>
<span class="sd">        of interest (QoI)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    elem_effects : np.ndarray(nvars,ntrajectories,nqoi)</span>
<span class="sd">        The elementary effects of each variable for each trajectory and QoI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nvars</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nqoi</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ntrajectories</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="p">(</span><span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">elem_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvars</span><span class="p">,</span> <span class="n">ntrajectories</span><span class="p">,</span> <span class="n">nqoi</span><span class="p">))</span>
    <span class="n">ix1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntrajectories</span><span class="p">):</span>
        <span class="n">ix2</span> <span class="o">=</span> <span class="n">ix1</span><span class="o">+</span><span class="n">nvars</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">ix1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ix2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">ix1</span><span class="p">:</span><span class="n">ix2</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">elem_effects</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">ix1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ix2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">values</span><span class="p">[</span><span class="n">ix1</span><span class="p">:</span><span class="n">ix2</span><span class="p">])</span><span class="o">/</span><span class="n">delta</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="n">ix2</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">elem_effects</span>


<span class="k">def</span> <span class="nf">get_morris_sensitivity_indices</span><span class="p">(</span><span class="n">elem_effects</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the Morris sensitivity indices mu and sigma from the elementary</span>
<span class="sd">    effects computed for a set of trajectories.</span>

<span class="sd">    Mu is the mu^\star from Campolongo et al.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elem_effects : np.ndarray(nvars,ntrajectories,nqoi)</span>
<span class="sd">        The elementary effects of each variable for each trajectory and</span>
<span class="sd">        quantity of interest (QoI)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mu : np.ndarray (nvars, nqoi)</span>
<span class="sd">        The sensitivity of each output to each input. Larger mu corresponds to</span>
<span class="sd">        higher sensitivity</span>

<span class="sd">    sigma: np.ndarray(nvars, nqoi)</span>
<span class="sd">        A measure of the non-linearity and/or interaction effects of each input</span>
<span class="sd">        for each output. Low values suggest a linear realationship between</span>
<span class="sd">        the input and output. Larger values suggest a that the output is</span>
<span class="sd">        nonlinearly dependent on the input and/or the input interacts with</span>
<span class="sd">        other inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">elem_effects</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mu</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">elem_effects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">elem_effects</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">elem_effects</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span>


<span class="k">def</span> <span class="nf">print_morris_sensitivity_indices</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">qoi</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">str_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;3}</span><span class="s2"> </span><span class="si">{:&gt;10}</span><span class="s2"> </span><span class="si">{:&gt;10}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">str_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;mu*&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">))</span>
    <span class="n">str_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;3}</span><span class="s2"> </span><span class="si">{:10.5f}</span><span class="s2"> </span><span class="si">{:10.5f}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">str_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Z_</span><span class="si">{</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">qoi</span><span class="p">],</span> <span class="n">sigma</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">qoi</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">downselect_morris_trajectories</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">ntrajectories</span><span class="p">):</span>
    <span class="n">nvars</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">ncandidate_trajectories</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="p">(</span><span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># assert 10*ntrajectories&lt;=ncandidate_trajectories</span>

    <span class="n">trajectories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">samples</span><span class="p">,</span> <span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncandidate_trajectories</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncandidate_trajectories</span><span class="p">,</span> <span class="n">ncandidate_trajectories</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncandidate_trajectories</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">distances</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span>
                <span class="n">trajectories</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">trajectories</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">distances</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span>

    <span class="n">get_combinations</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncandidate_trajectories</span><span class="p">),</span> <span class="n">ntrajectories</span><span class="p">)</span>
    <span class="n">ncombinations</span> <span class="o">=</span> <span class="n">nchoosek</span><span class="p">(</span><span class="n">ncandidate_trajectories</span><span class="p">,</span> <span class="n">ntrajectories</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ncombinations&#39;</span><span class="p">,</span> <span class="n">ncombinations</span><span class="p">)</span>
    <span class="c1"># values = np.empty(ncombinations)</span>
    <span class="n">best_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_value</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_combinations</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">distances</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]))</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">best_value</span><span class="p">:</span>
            <span class="n">best_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">best_index</span> <span class="o">=</span> <span class="n">index</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">trajectories</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">best_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">nvars</span><span class="p">,</span> <span class="n">ntrajectories</span><span class="o">*</span><span class="p">(</span><span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples</span>


<span class="k">class</span> <span class="nc">SensitivityResult</span><span class="p">(</span><span class="n">OptimizeResult</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="morris_sensitivities"><a class="viewcode-back" href="../../../api/pyapprox.analysis.morris_sensitivities.html#pyapprox.analysis.morris_sensitivities">[docs]</a><span class="k">def</span> <span class="nf">morris_sensitivities</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">ntrajectories</span><span class="p">,</span>
                         <span class="n">nlevels</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute sensitivity indices by constructing an adaptive polynomial chaos</span>
<span class="sd">    expansion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fun : callable</span>
<span class="sd">        The function being analyzed</span>

<span class="sd">        ``fun(z) -&gt; np.ndarray``</span>

<span class="sd">        where ``z`` is a 2D np.ndarray with shape (nvars,nsamples) and the</span>
<span class="sd">        output is a 2D np.ndarray with shape (nsamples,nqoi)</span>

<span class="sd">    variable : :py:class:`pyapprox.variables.IndependentMarginalsVariable`</span>
<span class="sd">         Object containing information of the joint density of the inputs z</span>
<span class="sd">         which is the tensor product of independent and identically distributed</span>
<span class="sd">         uniform variables.</span>

<span class="sd">    ntrajectories : integer</span>
<span class="sd">        The number of Morris trajectories requested</span>


<span class="sd">    nlevels : integer</span>
<span class="sd">        The number of levels used for to define the morris grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : :class:`pyapprox.analysis.sensitivity_analysis.SensitivityResult`</span>
<span class="sd">         Result object with the following attributes</span>

<span class="sd">    mu : np.ndarray (nvars,nqoi)</span>
<span class="sd">        The sensitivity of each output to each input. Larger mu corresponds to</span>
<span class="sd">        higher sensitivity</span>

<span class="sd">    sigma: np.ndarray (nvars,nqoi)</span>
<span class="sd">        A measure of the non-linearity and/or interaction effects of each input</span>
<span class="sd">        for each output. Low values suggest a linear realationship between</span>
<span class="sd">        the input and output. Larger values suggest a that the output is</span>
<span class="sd">        nonlinearly dependent on the input and/or the input interacts with</span>
<span class="sd">        other inputs</span>

<span class="sd">    samples : np.ndarray(nvars,ntrajectories*(nvars+1))</span>
<span class="sd">        The coordinates of each morris trajectory</span>

<span class="sd">    values : np.ndarray(nvars,nqoi)</span>
<span class="sd">        The values of ``fun`` at each sample in ``samples``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nvars</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">num_vars</span><span class="p">()</span>
    <span class="n">icdfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">ppf</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">marginals</span><span class="p">()]</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">get_morris_samples</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">,</span> <span class="n">ntrajectories</span><span class="p">,</span> <span class="n">icdfs</span><span class="o">=</span><span class="n">icdfs</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">elem_effects</span> <span class="o">=</span> <span class="n">get_morris_elementary_effects</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">get_morris_sensitivity_indices</span><span class="p">(</span><span class="n">elem_effects</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SensitivityResult</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;morris_mu&#39;</span><span class="p">:</span> <span class="n">mu</span><span class="p">,</span>
         <span class="s1">&#39;morris_sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span>
         <span class="s1">&#39;samples&#39;</span><span class="p">:</span> <span class="n">samples</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">})</span></div>


<div class="viewcode-block" id="sparse_grid_sobol_sensitivities"><a class="viewcode-back" href="../../../api/pyapprox.analysis.sparse_grid_sobol_sensitivities.html#pyapprox.analysis.sparse_grid_sobol_sensitivities">[docs]</a><span class="k">def</span> <span class="nf">sparse_grid_sobol_sensitivities</span><span class="p">(</span><span class="n">sparse_grid</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute sensitivity indices from a sparse grid</span>
<span class="sd">    by converting it to a polynomial chaos expansion</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sparse_grid :class:`pyapprox.adaptive_sparse_grid:CombinationSparseGrid`</span>
<span class="sd">       The sparse grid</span>

<span class="sd">    max_order : integer</span>
<span class="sd">        The maximum interaction order of Sobol indices to compute. A value</span>
<span class="sd">        of 2 will compute all pairwise interactions, a value of 3 will</span>
<span class="sd">        compute indices for all interactions involving 3 variables. The number</span>
<span class="sd">        of indices returned will be nchoosek(nvars+max_order,nvars). Warning</span>
<span class="sd">        when nvars is high the number of indices will increase rapidly with</span>
<span class="sd">        max_order.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : :class:`pyapprox.analysis.sensitivity_analysis.SensitivityResult`</span>
<span class="sd">         Result object with the following attributes</span>

<span class="sd">    main_effects : np.ndarray (nvars)</span>
<span class="sd">        The variance based main effect sensitivity indices</span>

<span class="sd">    total_effects : np.ndarray (nvars)</span>
<span class="sd">        The variance based total effect sensitivity indices</span>

<span class="sd">    sobol_indices : np.ndarray (nchoosek(nvars+max_order,nvars),nqoi)</span>
<span class="sd">        The variance based Sobol sensitivity indices</span>

<span class="sd">    sobol_interaction_indices : np.ndarray(nvars,nchoosek(nvars+max_order,nvars))</span>
<span class="sd">        Indices specifying the variables in each interaction in</span>
<span class="sd">        ``sobol_indices``</span>

<span class="sd">    pce : :class:`multivariate_polynomials.PolynomialChaosExpansion`</span>
<span class="sd">       The pce respresentation of the sparse grid ``approx``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pce_opts</span> <span class="o">=</span> <span class="n">define_poly_options_from_variable_transformation</span><span class="p">(</span>
        <span class="n">sparse_grid</span><span class="o">.</span><span class="n">var_trans</span><span class="p">)</span>
    <span class="n">pce</span> <span class="o">=</span> <span class="n">convert_sparse_grid_to_polynomial_chaos_expansion</span><span class="p">(</span>
        <span class="n">sparse_grid</span><span class="p">,</span> <span class="n">pce_opts</span><span class="p">)</span>
    <span class="n">pce_main_effects</span><span class="p">,</span> <span class="n">pce_total_effects</span> <span class="o">=</span>\
        <span class="n">get_main_and_total_effect_indices_from_pce</span><span class="p">(</span>
            <span class="n">pce</span><span class="o">.</span><span class="n">get_coefficients</span><span class="p">(),</span> <span class="n">pce</span><span class="o">.</span><span class="n">get_indices</span><span class="p">())</span>

    <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">pce_sobol_indices</span> <span class="o">=</span> <span class="n">get_sobol_indices</span><span class="p">(</span>
        <span class="n">pce</span><span class="o">.</span><span class="n">get_coefficients</span><span class="p">(),</span> <span class="n">pce</span><span class="o">.</span><span class="n">get_indices</span><span class="p">(),</span> <span class="n">max_order</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SensitivityResult</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;main_effects&#39;</span><span class="p">:</span> <span class="n">pce_main_effects</span><span class="p">,</span>
         <span class="s1">&#39;total_effects&#39;</span><span class="p">:</span> <span class="n">pce_total_effects</span><span class="p">,</span>
         <span class="s1">&#39;sobol_indices&#39;</span><span class="p">:</span> <span class="n">pce_sobol_indices</span><span class="p">,</span>
         <span class="s1">&#39;sobol_interaction_indices&#39;</span><span class="p">:</span> <span class="n">interaction_terms</span><span class="p">,</span>
         <span class="s1">&#39;pce&#39;</span><span class="p">:</span> <span class="n">pce</span><span class="p">})</span></div>


<div class="viewcode-block" id="gpc_sobol_sensitivities"><a class="viewcode-back" href="../../../api/pyapprox.analysis.gpc_sobol_sensitivities.html#pyapprox.analysis.gpc_sobol_sensitivities">[docs]</a><span class="k">def</span> <span class="nf">gpc_sobol_sensitivities</span><span class="p">(</span><span class="n">pce</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">max_order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute variance based sensitivity metrics from a polynomial chaos</span>
<span class="sd">    expansion</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pce :class:`pyapprox.surrogates.polychaos.gpc.PolynomialChaosExpansion`</span>
<span class="sd">       The polynomial chaos expansion</span>

<span class="sd">    max_order : integer</span>
<span class="sd">        The maximum interaction order of Sobol indices to compute. A value</span>
<span class="sd">        of 2 will compute all pairwise interactions, a value of 3 will</span>
<span class="sd">        compute indices for all interactions involving 3 variables. The number</span>
<span class="sd">        of indices returned will be nchoosek(nvars+max_order,nvars). Warning</span>
<span class="sd">        when nvars is high the number of indices will increase rapidly with</span>
<span class="sd">        max_order.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : :class:`pyapprox.analysis.sensitivity_analysis.SensitivityResult`</span>
<span class="sd">         Result object with the following attributes</span>

<span class="sd">    main_effects : np.ndarray (nvars, nqoi)</span>
<span class="sd">        The variance based main effect sensitivity indices</span>

<span class="sd">    total_effects : np.ndarray (nvars, nqoi)</span>
<span class="sd">        The variance based total effect sensitivity indices</span>

<span class="sd">    sobol_indices : np.ndarray (nchoosek(nvars+max_order,nvars), nqoi)</span>
<span class="sd">        The variance based Sobol sensitivity indices</span>

<span class="sd">    sobol_interaction_indices : np.ndarray(nvars, nchoosek(nvars+max_order, nvars))</span>
<span class="sd">        Indices specifying the variables in each interaction in</span>
<span class="sd">        ``sobol_indices``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pce</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">PolynomialChaosExpansion</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide a PCE&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">marginals</span><span class="p">()</span> <span class="o">!=</span> <span class="n">pce</span><span class="o">.</span><span class="n">var_trans</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">marginals</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;variable is inconsistent with PCE. &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Can only compute sensitivities with respect to variable &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;used to build the PCE&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">pce_main_effects</span><span class="p">,</span> <span class="n">pce_total_effects</span> <span class="o">=</span>\
        <span class="n">get_main_and_total_effect_indices_from_pce</span><span class="p">(</span>
            <span class="n">pce</span><span class="o">.</span><span class="n">get_coefficients</span><span class="p">(),</span> <span class="n">pce</span><span class="o">.</span><span class="n">get_indices</span><span class="p">())</span>

    <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">pce_sobol_indices</span> <span class="o">=</span> <span class="n">get_sobol_indices</span><span class="p">(</span>
        <span class="n">pce</span><span class="o">.</span><span class="n">get_coefficients</span><span class="p">(),</span> <span class="n">pce</span><span class="o">.</span><span class="n">get_indices</span><span class="p">(),</span>
        <span class="n">max_order</span><span class="o">=</span><span class="n">max_order</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SensitivityResult</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;main_effects&#39;</span><span class="p">:</span> <span class="n">pce_main_effects</span><span class="p">,</span>
         <span class="s1">&#39;total_effects&#39;</span><span class="p">:</span> <span class="n">pce_total_effects</span><span class="p">,</span>
         <span class="s1">&#39;sobol_indices&#39;</span><span class="p">:</span> <span class="n">pce_sobol_indices</span><span class="p">,</span>
         <span class="s1">&#39;sobol_interaction_indices&#39;</span><span class="p">:</span> <span class="n">interaction_terms</span><span class="p">})</span></div>


<span class="k">def</span> <span class="nf">generate_sobol_index_sample_sets</span><span class="p">(</span><span class="n">samplesA</span><span class="p">,</span> <span class="n">samplesB</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given two sample sets A and B generate the sets :math:`A_B^{I}` from</span>

<span class="sd">    The rows of A_B^I are all from A except for the rows with non zero entries</span>
<span class="sd">    in the index I. When A and B are QMC samples it is best to change as few</span>
<span class="sd">    rows as possible</span>

<span class="sd">    See</span>

<span class="sd">    Variance based sensitivity analysis of model output. Design and estimator</span>
<span class="sd">    for the total sensitivity index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nvars</span> <span class="o">=</span> <span class="n">samplesA</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">II</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvars</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">samplesA</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">samplesB</span><span class="p">[</span><span class="n">mask</span><span class="p">]])</span>
    <span class="n">JJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">II</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">II</span><span class="p">[</span><span class="n">mask</span><span class="p">]])</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">JJ</span><span class="p">),</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">samples</span>


<span class="k">def</span> <span class="nf">get_AB_sample_sets_for_sobol_sensitivity_analysis</span><span class="p">(</span>
        <span class="n">variables</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">qmc_start_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
        <span class="n">samplesA</span> <span class="o">=</span> <span class="n">generate_independent_random_samples</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)</span>
        <span class="n">samplesB</span> <span class="o">=</span> <span class="n">generate_independent_random_samples</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;halton&#39;</span> <span class="ow">or</span> <span class="s1">&#39;sobol&#39;</span><span class="p">:</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">num_vars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;halton&#39;</span><span class="p">:</span>
            <span class="n">qmc_samples</span> <span class="o">=</span> <span class="n">halton_sequence</span><span class="p">(</span>
                <span class="mi">2</span><span class="o">*</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">qmc_start_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qmc_samples</span> <span class="o">=</span> <span class="n">sobol_sequence</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">qmc_start_index</span><span class="p">)</span>
        <span class="n">samplesA</span> <span class="o">=</span> <span class="n">qmc_samples</span><span class="p">[:</span><span class="n">nvars</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">samplesB</span> <span class="o">=</span> <span class="n">qmc_samples</span><span class="p">[</span><span class="n">nvars</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">rv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">marginals</span><span class="p">()):</span>
            <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># transformation is undefined at [0,1] for unbouned</span>
            <span class="c1"># random variables</span>
            <span class="c1"># create bounds for unbounded interval that exclude 1e-8</span>
            <span class="c1"># of the total probability</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">nlb</span><span class="p">,</span> <span class="n">nub</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">cdf</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lb</span><span class="p">):</span>
                <span class="n">samplesA</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">samplesA</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlb</span>
                <span class="n">samplesB</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">samplesB</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlb</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ub</span><span class="p">):</span>
                <span class="n">samplesA</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">samplesA</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nub</span>
                <span class="n">samplesB</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">samplesB</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nub</span>
            <span class="n">samplesA</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samplesA</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">samplesB</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samplesB</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samplesA</span><span class="p">,</span> <span class="n">samplesB</span>


<span class="k">def</span> <span class="nf">sampling_based_sobol_indices</span><span class="p">(</span>
        <span class="n">fun</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">sampling_method</span><span class="o">=</span><span class="s1">&#39;sobol&#39;</span><span class="p">,</span>
        <span class="n">qmc_start_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See I.M. Sobol. Mathematics and Computers in Simulation 55 (2001) 271–280</span>

<span class="sd">    and</span>

<span class="sd">    Saltelli, Annoni et. al, Variance based sensitivity analysis of model</span>
<span class="sd">    output. Design and estimator for the total sensitivity index. 2010.</span>
<span class="sd">    https://doi.org/10.1016/j.cpc.2009.09.018</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    interaction_terms : np.ndarray (nvars, nterms)</span>
<span class="sd">        Index defining the active terms in each interaction. If the</span>
<span class="sd">        ith  variable is active interaction_terms[i] == 1 and zero otherwise</span>
<span class="sd">        This index must be downward closed due to way sobol indices are</span>
<span class="sd">        computed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nvars</span> <span class="o">=</span> <span class="n">interaction_terms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nterms</span> <span class="o">=</span> <span class="n">interaction_terms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">samplesA</span><span class="p">,</span> <span class="n">samplesB</span> <span class="o">=</span> <span class="n">get_AB_sample_sets_for_sobol_sensitivity_analysis</span><span class="p">(</span>
        <span class="n">variables</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">sampling_method</span><span class="p">,</span> <span class="n">qmc_start_index</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">nvars</span> <span class="o">==</span> <span class="n">samplesA</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">valuesA</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">samplesA</span><span class="p">)</span>
    <span class="n">valuesB</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">samplesB</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">valuesA</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">valuesA</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">interaction_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nterms</span><span class="p">,</span> <span class="n">valuesA</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">total_effect_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">)]</span>
    <span class="n">interaction_values_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nterms</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">interaction_terms</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">index</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">samplesAB</span> <span class="o">=</span> <span class="n">generate_sobol_index_sample_sets</span><span class="p">(</span>
            <span class="n">samplesA</span><span class="p">,</span> <span class="n">samplesB</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">valuesAB</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">samplesAB</span><span class="p">)</span>
        <span class="c1"># entry b in Table 2 of Saltelli, Annoni et. al</span>
        <span class="n">interaction_values</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
            <span class="p">(</span><span class="n">valuesB</span><span class="o">*</span><span class="p">(</span><span class="n">valuesAB</span><span class="o">-</span><span class="n">valuesA</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">variance</span>
        <span class="n">interaction_values_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">ii</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># entry f in Table 2 of Saltelli, Annoni et. al</span>
            <span class="n">total_effect_values</span><span class="p">[</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">valuesA</span><span class="o">-</span><span class="n">valuesAB</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">variance</span>

    <span class="c1"># must substract of contributions from lower-dimensional terms from</span>
    <span class="c1"># each interaction value For example, let R_ij be interaction_values</span>
    <span class="c1"># the sobol index S_ij satisfies R_ij = S_i + S_j + S_ij</span>
    <span class="n">II</span> <span class="o">=</span> <span class="n">argsort_indices_leixographically</span><span class="p">(</span><span class="n">interaction_terms</span><span class="p">)</span>
    <span class="n">sobol_indices</span> <span class="o">=</span> <span class="n">interaction_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sobol_indices_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">II</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">interaction_terms</span><span class="p">[:,</span> <span class="n">II</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="n">active_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nactive_vars</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">sobol_indices_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">active_vars</span><span class="p">)]</span> <span class="o">=</span> <span class="n">II</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nactive_vars</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nactive_vars</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span><span class="n">active_vars</span><span class="p">,</span> <span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                    <span class="n">sobol_indices</span><span class="p">[</span><span class="n">II</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">-=</span> \
                        <span class="n">sobol_indices</span><span class="p">[</span><span class="n">sobol_indices_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>

    <span class="n">total_effect_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">total_effect_values</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">variance</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># main_effects = sobol_indices[interaction_terms.sum(axis=0)==1, :]</span>
    <span class="c1"># We cannot guarantee that the main_effects will be &lt;= 1. Because</span>
    <span class="c1"># variance and each interaction_index are computed with different sample</span>
    <span class="c1"># sets. Consider function of two variables which is constant in one</span>
    <span class="c1"># variable</span>
    <span class="c1"># then interaction_index[0] should equal variance. But with different</span>
    <span class="c1"># sample</span>
    <span class="c1"># sets interaction_index could be smaller or larger than the variance.</span>
    <span class="c1"># assert np.all(main_effects&lt;=1)</span>
    <span class="c1"># Similarly we cannot even guarantee main effects will be non-negative</span>
    <span class="c1"># assert np.all(main_effects&gt;=0)</span>
    <span class="c1"># We also cannot guarantee that the sobol indices will be non-negative.</span>
    <span class="c1"># assert np.all(total_effect_values&gt;=0)</span>
    <span class="c1"># assert np.all(sobol_indices&gt;=0)</span>
    <span class="k">return</span> <span class="n">sobol_indices</span><span class="p">,</span> <span class="n">total_effect_values</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">mean</span>


<span class="k">def</span> <span class="nf">repeat_sampling_based_sobol_indices</span><span class="p">(</span>
        <span class="n">fun</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nsamples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">sampling_method</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
        <span class="n">nsobol_realizations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">summary_stats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;quantile-0.25&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;quantile-0.75&quot;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute sobol indices for different sample sets. This allows estimation</span>
<span class="sd">    of error due to finite sample sizes. This function requires evaluting</span>
<span class="sd">    the function at nsobol_realizations * N, where N is the</span>
<span class="sd">    number of samples required by sampling_based_sobol_indices. Thus</span>
<span class="sd">    This function is useful when applid to a random</span>
<span class="sd">    realization of a Gaussian process requires the Cholesky decomposition</span>
<span class="sd">    of a nsamples x nsamples matrix which becomes to costly for nsamples &gt;1000</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">interaction_terms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interaction_terms</span> <span class="o">=</span> <span class="n">get_isotropic_anova_indices</span><span class="p">(</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">num_vars</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">stat_functions</span> <span class="o">=</span> <span class="n">_get_stats_functions</span><span class="p">(</span><span class="n">summary_stats</span><span class="p">)</span>

    <span class="n">means</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">sobol_values</span><span class="p">,</span>  <span class="n">total_values</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">qmc_start_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsobol_realizations</span><span class="p">):</span>
        <span class="n">sv</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="n">vr</span><span class="p">,</span> <span class="n">me</span> <span class="o">=</span> <span class="n">sampling_based_sobol_indices</span><span class="p">(</span>
            <span class="n">fun</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span>
            <span class="n">sampling_method</span><span class="o">=</span><span class="s1">&#39;sobol&#39;</span><span class="p">,</span> <span class="n">qmc_start_index</span><span class="o">=</span><span class="n">qmc_start_index</span><span class="p">)</span>
        <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="n">variances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vr</span><span class="p">)</span>
        <span class="n">sobol_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sv</span><span class="p">)</span>
        <span class="n">total_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tv</span><span class="p">)</span>
        <span class="n">qmc_start_index</span> <span class="o">+=</span> <span class="n">nsamples</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
    <span class="n">variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
    <span class="n">sobol_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sobol_values</span><span class="p">)</span>
    <span class="n">total_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">total_values</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">interaction_terms</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>

    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_interaction_indices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interaction_terms</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">sobol_values</span><span class="p">,</span> <span class="n">total_values</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">means</span><span class="p">]</span>
    <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sobol_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;total_effects&#39;</span><span class="p">,</span> <span class="s1">&#39;variance&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_names</span><span class="p">):</span>
        <span class="n">subdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">sfun</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stat_functions</span><span class="p">):</span>
            <span class="n">subdict</span><span class="p">[</span><span class="n">sfun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfun</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">subdict</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdict</span>

    <span class="c1"># return sobol_values, total_values, variances, means</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_get_stats_functions</span><span class="p">(</span><span class="n">summary_stats</span><span class="p">):</span>
    <span class="n">quantile_stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]:</span>
        <span class="n">sfun</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
        <span class="n">sfun</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;quantile-</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">quantile_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sfun</span><span class="p">)</span>
    <span class="n">stat_functions_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
                           <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">,</span>
                           <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
                           <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                           <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">,</span>
                           <span class="s2">&quot;quantile-0.25&quot;</span><span class="p">:</span> <span class="n">quantile_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="s2">&quot;quantile-0.75&quot;</span><span class="p">:</span> <span class="n">quantile_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">summary_stats</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stat_functions_dict</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Summary stats </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not supported</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Select from </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">stat_functions_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">stat_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat_functions_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">summary_stats</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">stat_functions</span>


<span class="k">def</span> <span class="nf">analytic_sobol_indices_from_gaussian_process</span><span class="p">(</span>
        <span class="n">gp</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ngp_realizations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">summary_stats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;quantile-0.25&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;quantile-0.75&quot;</span><span class="p">],</span>
        <span class="n">ninterpolation_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nvalidation_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">ncandidate_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">nquad_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">use_cholesky</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">ninterpolation_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ninterpolation_samples</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">gp</span><span class="o">.</span><span class="n">num_training_samples</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">gp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">GaussianProcess</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument gp must be a Gaussian process&quot;</span><span class="p">)</span>

    <span class="n">stat_functions</span> <span class="o">=</span> <span class="n">_get_stats_functions</span><span class="p">(</span><span class="n">summary_stats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">interaction_terms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interaction_terms</span> <span class="o">=</span> <span class="n">get_isotropic_anova_indices</span><span class="p">(</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">num_vars</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">K_inv</span><span class="p">,</span> <span class="n">lscale</span><span class="p">,</span> <span class="n">kernel_var</span><span class="p">,</span> <span class="n">transform_quad_rules</span> <span class="o">=</span> \
        <span class="n">extract_gaussian_process_attributes_for_integration</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ngp_realizations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">gp_realizations</span> <span class="o">=</span> <span class="n">generate_gp_realizations</span><span class="p">(</span>
            <span class="n">gp</span><span class="p">,</span> <span class="n">ngp_realizations</span><span class="p">,</span> <span class="n">ninterpolation_samples</span><span class="p">,</span> <span class="n">nvalidation_samples</span><span class="p">,</span>
            <span class="n">ncandidate_samples</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">use_cholesky</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span>

        <span class="c1"># Check how accurate realizations</span>
        <span class="n">validation_samples</span> <span class="o">=</span> <span class="n">generate_independent_random_samples</span><span class="p">(</span>
            <span class="n">variable</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">mean_vals</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="p">(</span><span class="n">validation_samples</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">realization_vals</span> <span class="o">=</span> <span class="n">gp_realizations</span><span class="p">(</span><span class="n">validation_samples</span><span class="p">)</span>
        <span class="c1"># print(mean_vals[:, 0].mean())</span>
        <span class="c1"># print(std,realization_vals.std(axis=1))</span>
        <span class="c1"># this checks the accuracy of the number of realizations.</span>
        <span class="c1"># error will decrease with number of samples</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;std of realizations error&#39;</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">std</span><span class="o">-</span><span class="n">realization_vals</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">std</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;var of realizations error&#39;</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">std</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">realization_vals</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">std</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mean interpolation error&#39;</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">mean_vals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">realization_vals</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mean_vals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="n">x_train</span> <span class="o">=</span> <span class="n">gp_realizations</span><span class="o">.</span><span class="n">selected_canonical_samples</span>
        <span class="c1"># gp_realizations.train_vals is normalized so unnormalize</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">_y_train_std</span><span class="o">*</span><span class="n">gp_realizations</span><span class="o">.</span><span class="n">train_vals</span>
        <span class="c1"># kernel_var has already been adjusted by call to</span>
        <span class="c1"># extract_gaussian_process_attributes_for_integration</span>
        <span class="n">K_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">gp_realizations</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gp_realizations</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">K_inv</span> <span class="o">/=</span> <span class="n">gp</span><span class="o">.</span><span class="n">_y_train_std</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">sobol_values</span><span class="p">,</span> <span class="n">total_values</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">variances</span> <span class="o">=</span> \
        <span class="n">_compute_expected_sobol_indices</span><span class="p">(</span>
            <span class="n">gp</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">nquad_samples</span><span class="p">,</span>
            <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">K_inv</span><span class="p">,</span> <span class="n">lscale</span><span class="p">,</span> <span class="n">kernel_var</span><span class="p">,</span>
            <span class="n">transform_quad_rules</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">_y_train_mean</span><span class="p">)</span>
    <span class="n">sobol_values</span> <span class="o">=</span> <span class="n">sobol_values</span><span class="o">.</span><span class="n">T</span>
    <span class="n">total_values</span> <span class="o">=</span> <span class="n">total_values</span><span class="o">.</span><span class="n">T</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">interaction_terms</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>

    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_interaction_indices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interaction_terms</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">sobol_values</span><span class="p">,</span> <span class="n">total_values</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">means</span><span class="p">]</span>
    <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sobol_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;total_effects&#39;</span><span class="p">,</span> <span class="s1">&#39;variance&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_names</span><span class="p">):</span>
        <span class="n">subdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">sfun</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stat_functions</span><span class="p">):</span>
            <span class="n">subdict</span><span class="p">[</span><span class="n">sfun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfun</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">subdict</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdict</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">sampling_based_sobol_indices_from_gaussian_process</span><span class="p">(</span>
    <span class="n">gp</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">sampling_method</span><span class="o">=</span><span class="s1">&#39;sobol&#39;</span><span class="p">,</span>
        <span class="n">ngp_realizations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nsobol_realizations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">stat_functions</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">),</span>
        <span class="n">ninterpolation_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">nvalidation_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">ncandidate_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">use_cholesky</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute sobol indices from Gaussian process using sampling.</span>
<span class="sd">    This function returns the mean and variance of these values with</span>
<span class="sd">    respect to the variability in the GP (i.e. its function error)</span>

<span class="sd">    Following Kennedy and O&#39;hagan we evaluate random realizations of each</span>
<span class="sd">    GP at a discrete set of points. To predict at larger sample sizes we</span>
<span class="sd">    interpolate these points and use the resulting approximation to make any</span>
<span class="sd">    subsequent predictions. This introduces an error but the error can be</span>
<span class="sd">    made arbitrarily small by setting ninterpolation_samples large enough.</span>
<span class="sd">    The geometry of the interpolation samples can effect accuracy of the</span>
<span class="sd">    interpolants. Consequently we use Pivoted cholesky algorithm in</span>
<span class="sd">    Harbrecht et al for choosing the interpolation samples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ngp_realizations : integer</span>
<span class="sd">        The number of random realizations of the Gaussian process</span>
<span class="sd">        if ngp_realizations == 0 then the sensitivity indices will</span>
<span class="sd">        only be computed using the mean of the GP.</span>

<span class="sd">    nsobol_realizations : integer</span>
<span class="sd">        The number of random realizations of the random samples used to</span>
<span class="sd">        compute the sobol indices. This number should be similar to</span>
<span class="sd">        ngp_realizations, as mean and stdev are taken over both these</span>
<span class="sd">        random values.</span>

<span class="sd">    stat_functions : list</span>
<span class="sd">        List of callable functions with signature fun(np.ndarray)</span>
<span class="sd">        E.g. np.mean. If fun has arguments then we must wrap then with partial</span>
<span class="sd">        and set a meaniningful __name__, e.g. fun = partial(np.quantile, q=0.5)</span>
<span class="sd">        fun.__name__ == &#39;quantile-0.25&#39;.</span>
<span class="sd">        Note: np.min and np.min names are amin, amax</span>

<span class="sd">    ninterpolation_samples : integer</span>
<span class="sd">        The number of samples used to interpolate the discrete random</span>
<span class="sd">        realizations of a Gaussian Process</span>

<span class="sd">    nvalidation_samples : integer</span>
<span class="sd">        The number of samples used to assess the accuracy of the interpolants</span>
<span class="sd">        of the random realizations</span>

<span class="sd">    ncandidate_samples : integer</span>
<span class="sd">        The number of candidate samples selected from when building the</span>
<span class="sd">        interpolants of the random realizations</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : dictionary</span>
<span class="sd">        Result containing the numpy functions in stat_funtions applied</span>
<span class="sd">        to the mean, variance, sobol_indices and total_effects of the Gaussian</span>
<span class="sd">        process. To access the data associated with a fun in stat_function</span>
<span class="sd">        use the key fun.__name__, For example  if the stat_function is np.mean</span>
<span class="sd">        the mean sobol indices are accessed via result[&#39;sobol_indices&#39;][&#39;mean&#39;]</span>
<span class="sd">        The raw values of each iteration are stored in</span>
<span class="sd">        result[&#39;sobol_indices][&#39;values&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">nsobol_realizations</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">ngp_realizations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ncandidate_samples</span> <span class="o">&gt;</span> <span class="n">ninterpolation_samples</span>
        <span class="n">gp_realizations</span> <span class="o">=</span> <span class="n">generate_gp_realizations</span><span class="p">(</span>
            <span class="n">gp</span><span class="p">,</span> <span class="n">ngp_realizations</span><span class="p">,</span> <span class="n">ninterpolation_samples</span><span class="p">,</span> <span class="n">nvalidation_samples</span><span class="p">,</span>
            <span class="n">ncandidate_samples</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">use_cholesky</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="n">gp_realizations</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="n">gp</span>

    <span class="n">sobol_values</span><span class="p">,</span> <span class="n">total_values</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">means</span> <span class="o">=</span> \
        <span class="n">repeat_sampling_based_sobol_indices</span><span class="p">(</span>
            <span class="n">fun</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span>
            <span class="n">sampling_method</span><span class="p">,</span> <span class="n">nsobol_realizations</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">sobol_values</span><span class="p">,</span> <span class="n">total_values</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">means</span><span class="p">]</span>
    <span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sobol_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;total_effects&#39;</span><span class="p">,</span> <span class="s1">&#39;variance&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_names</span><span class="p">):</span>
        <span class="n">subdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">sfun</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stat_functions</span><span class="p">):</span>
            <span class="c1"># have to deal with averaging over axis = (0, 1) and axis = (0, 2)</span>
            <span class="c1"># for mean, variance and sobol_indices, total_effects respectively</span>
            <span class="n">subdict</span><span class="p">[</span><span class="n">sfun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfun</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">subdict</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdict</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_borgonovo_estimation</span><span class="p">(</span>
        <span class="n">samples</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">marginal_icdfs</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">nvars</span><span class="p">,</span> <span class="n">nsamples</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nqoi</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nsamples</span>

    <span class="k">if</span> <span class="n">nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of bins&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sa_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvars</span><span class="p">,</span> <span class="n">nqoi</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
        <span class="n">bin_bounds</span> <span class="o">=</span> <span class="n">marginal_icdfs</span><span class="p">[</span><span class="n">ii</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbins</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="p">):</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">samples</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">bin_bounds</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">bin_bounds</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nsamples_ii</span> <span class="o">=</span> <span class="n">inds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sa_indices</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nsamples_ii</span><span class="o">/</span><span class="n">nsamples</span><span class="o">*</span><span class="p">(</span>
                <span class="n">values</span><span class="p">[</span><span class="n">inds</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">sa_indices</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">/=</span> <span class="n">variance</span>
    <span class="k">return</span> <span class="n">sa_indices</span>


<span class="k">def</span> <span class="nf">bootstrapped_borgonovo_sensivities</span><span class="p">(</span>
        <span class="n">fun</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbootstraps</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute main-effect sensitivity indices for a model using</span>
<span class="sd">    algorithm from [BHPRA2016]_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        fun : callable</span>
<span class="sd">        The function to be approximated</span>

<span class="sd">        ``fun(z) -&gt; np.ndarray``</span>

<span class="sd">        where ``z`` is a 2D np.ndarray with shape (nvars, nsamples) and the</span>
<span class="sd">        output is a 2D np.ndarray with shape (nsamples, nqoi)</span>

<span class="sd">    variable : pya.IndependentMarginalsVariable</span>
<span class="sd">        Object containing information of the joint density of the inputs z.</span>
<span class="sd">        This is used to generate random samples from this join density</span>

<span class="sd">    nsamples : integer</span>
<span class="sd">        The number of samples used to compute the sensitivity indices</span>

<span class="sd">    nbins : integer</span>
<span class="sd">        The number of bins used to divide the domain of each marginal variable</span>

<span class="sd">    nbootstraps : integer</span>
<span class="sd">        The number of bootstraps used to obtain estimates of error in the</span>
<span class="sd">        sensitivity indices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : SensitivityResult</span>
<span class="sd">       Object containing the sensitivity indices</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    `Borgonovo, E., Hazen, G. and Plischke, E. A Common Rationale for Global Sensitivity Measures and Their Estimation. 36(10):1871-1895, 2016. &lt;https://doi.org/10.1111/risa.12555&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nvars</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">num_vars</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">nsamples</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">nqoi</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sa_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbootstraps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nvars</span><span class="p">,</span> <span class="n">nqoi</span><span class="p">))</span>
    <span class="n">marginal_icdfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">ppf</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">marginals</span><span class="p">()]</span>
    <span class="n">sa_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_borgonovo_estimation</span><span class="p">(</span>
        <span class="n">samples</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">marginal_icdfs</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nbootstraps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">permuted_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nsamples</span><span class="p">),</span> <span class="n">nsamples</span><span class="p">)</span>
        <span class="n">psamples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span> <span class="n">permuted_inds</span><span class="p">]</span>
        <span class="n">pvalues</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">permuted_inds</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">sa_indices</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_borgonovo_estimation</span><span class="p">(</span>
            <span class="n">psamples</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">marginal_icdfs</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sa_indices</span>


<div class="viewcode-block" id="run_sensitivity_analysis"><a class="viewcode-back" href="../../../api/pyapprox.analysis.run_sensitivity_analysis.html#pyapprox.analysis.run_sensitivity_analysis">[docs]</a><span class="k">def</span> <span class="nf">run_sensitivity_analysis</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute sensitivity indices for a model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method : string</span>
<span class="sd">        The name of the sensitivity method</span>

<span class="sd">    fun : callable</span>
<span class="sd">        The function to be approximated</span>

<span class="sd">        ``fun(z) -&gt; np.ndarray``</span>

<span class="sd">        where ``z`` is a 2D np.ndarray with shape (nvars, nsamples) and the</span>
<span class="sd">        output is a 2D np.ndarray with shape (nsamples, nqoi)</span>


<span class="sd">    variable : pya.IndependentMarginalsVariable</span>
<span class="sd">        Object containing information of the joint density of the inputs z.</span>
<span class="sd">        This is used to generate random samples from this join density</span>

<span class="sd">    args: kwargs</span>
<span class="sd">        optional keyword arguments</span>

<span class="sd">    kwargs: kwargs</span>
<span class="sd">        optional keyword arguments</span>

<span class="sd">    For more details on method specfici args, kwargs and results attributes see</span>

<span class="sd">        - :func:`pyapprox.analysis.sensitivity_analysis.sampling_based_sobol_indices`</span>

<span class="sd">        - :func:`pyapprox.analysis.sensitivity_analysis.bootstrapped_borgonovo_sensivities`</span>

<span class="sd">        - :func:`pyapprox.analysis.sensitivity_analysis.morris_sensitivities`</span>

<span class="sd">        - :func:`pyapprox.analysis.sensitivity_analysis.gpc_sobol_sensitivities`</span>

<span class="sd">        - :func:`pyapprox.analysis.sensitivity_analysis.analytic_sobol_indices_from_gaussian_process`</span>

<span class="sd">        - : func:`pyapprox.analysis.sensitivity_analysis.sparse_grid_sobol_sensitivities`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : SensitivityResult</span>
<span class="sd">       Object containing the sensitivity indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pyapprox.surrogates.polychaos.adaptive_polynomial_chaos</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">AdaptiveInducedPCE</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">pyapprox.surrogates.interp.adaptive_sparse_grid</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">CombinationSparseGrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;surrogate_sobol&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span> <span class="n">GaussianProcess</span><span class="p">):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;gp_sobol&quot;</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span> <span class="n">AdaptiveInducedPCE</span><span class="p">):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;pce_sobol&quot;</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">pce</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span> <span class="o">==</span> <span class="n">PolynomialChaosExpansion</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;pce_sobol&quot;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span> <span class="o">==</span> <span class="n">CombinationSparseGrid</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;sg_sobol&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Surrogate specific computation requested, but fun&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;is not a type of surrogate supported&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">methods</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sobol&quot;</span><span class="p">:</span> <span class="n">repeat_sampling_based_sobol_indices</span><span class="p">,</span>
        <span class="s2">&quot;bin_sobol&quot;</span><span class="p">:</span> <span class="n">bootstrapped_borgonovo_sensivities</span><span class="p">,</span>
        <span class="s2">&quot;morris&quot;</span><span class="p">:</span> <span class="n">morris_sensitivities</span><span class="p">,</span>
        <span class="s2">&quot;pce_sobol&quot;</span><span class="p">:</span> <span class="n">gpc_sobol_sensitivities</span><span class="p">,</span>
        <span class="s2">&quot;gp_sobol&quot;</span><span class="p">:</span> <span class="n">analytic_sobol_indices_from_gaussian_process</span><span class="p">,</span>
        <span class="s2">&quot;sg_sobol&quot;</span><span class="p">:</span> <span class="n">sparse_grid_sobol_sensitivities</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Method &quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&quot; not found.</span><span class="se">\n</span><span class="s1"> Available methods are:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">methods</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="n">fun</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">get_isotropic_anova_indices</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="n">compute_hyperbolic_indices</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="n">interaction_terms</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">interaction_terms</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">interaction_terms</span>


<span class="k">def</span> <span class="nf">_plot_sensitivity_indices</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">sa_indices</span><span class="p">):</span>
    <span class="n">nindices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sa_indices</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">nindices</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sa_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">sa_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bp</span>


<span class="k">def</span> <span class="nf">_get_sobol_indices_labels</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">interaction_terms</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_interaction_indices&quot;</span><span class="p">]</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction_terms</span><span class="p">)):</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="s1">&#39;($&#39;</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction_terms</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ll</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">},&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ll</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">}$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">interaction_terms</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">labels</span>


<div class="viewcode-block" id="plot_sensitivity_indices"><a class="viewcode-back" href="../../../api/pyapprox.analysis.plot_sensitivity_indices.html#pyapprox.analysis.plot_sensitivity_indices">[docs]</a><span class="k">def</span> <span class="nf">plot_sensitivity_indices</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="k">if</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="s2">&quot;z&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_effects&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">include_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">include_vars</span><span class="p">]</span>
        <span class="n">im0</span> <span class="o">=</span> <span class="n">_plot_sensitivity_indices</span><span class="p">(</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][:</span><span class="n">nvars</span><span class="p">][</span><span class="n">include_vars</span><span class="p">])</span>
        <span class="n">im1</span> <span class="o">=</span> <span class="n">_plot_sensitivity_indices</span><span class="p">(</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_effects&quot;</span><span class="p">][</span><span class="n">include_vars</span><span class="p">])</span>
        <span class="n">II</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">10</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">_get_sobol_indices_labels</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">II</span><span class="p">]</span>
        <span class="n">im2</span> <span class="o">=</span> <span class="n">_plot_sensitivity_indices</span><span class="p">(</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="n">II</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">im0</span><span class="p">,</span> <span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">],</span> <span class="n">axs</span>

    <span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_effects&#39;</span><span class="p">][</span><span class="s1">&#39;median&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">include_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">include_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">im0</span> <span class="o">=</span> <span class="n">plot_sensitivity_indices_with_confidence_intervals</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">include_vars</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">][:</span><span class="n">nvars</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;quantile-0.25&quot;</span><span class="p">][:</span><span class="n">nvars</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;quantile-0.75&quot;</span><span class="p">][:</span><span class="n">nvars</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;amin&quot;</span><span class="p">][:</span><span class="n">nvars</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;amax&quot;</span><span class="p">][:</span><span class="n">nvars</span><span class="p">][</span><span class="n">include_vars</span><span class="p">])</span>

    <span class="n">im1</span> <span class="o">=</span> <span class="n">plot_sensitivity_indices_with_confidence_intervals</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$</span><span class="si">%s</span><span class="s1">_{</span><span class="si">%d</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">include_vars</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_effects&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_effects&quot;</span><span class="p">][</span><span class="s2">&quot;quantile-0.25&quot;</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_effects&quot;</span><span class="p">][</span><span class="s2">&quot;quantile-0.75&quot;</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_effects&quot;</span><span class="p">][</span><span class="s2">&quot;amin&quot;</span><span class="p">][</span><span class="n">include_vars</span><span class="p">],</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_effects&quot;</span><span class="p">][</span><span class="s2">&quot;amax&quot;</span><span class="p">][</span><span class="n">include_vars</span><span class="p">])</span>

    <span class="c1"># sort sobol indices largest to smallest values left to right</span>
    <span class="n">II</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())[</span><span class="o">-</span><span class="mi">10</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">_get_sobol_indices_labels</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">II</span><span class="p">]</span>
    <span class="n">median_sobol_indices</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">][</span><span class="n">II</span><span class="p">]</span>
    <span class="n">q1_sobol_indices</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;quantile-0.25&quot;</span><span class="p">][</span><span class="n">II</span><span class="p">]</span>
    <span class="n">q3_sobol_indices</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;quantile-0.75&quot;</span><span class="p">][</span><span class="n">II</span><span class="p">]</span>
    <span class="n">min_sobol_indices</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;amin&quot;</span><span class="p">][</span><span class="n">II</span><span class="p">]</span>
    <span class="n">max_sobol_indices</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;sobol_indices&quot;</span><span class="p">][</span><span class="s2">&quot;amax&quot;</span><span class="p">][</span><span class="n">II</span><span class="p">]</span>
    <span class="n">im2</span> <span class="o">=</span> <span class="n">plot_sensitivity_indices_with_confidence_intervals</span><span class="p">(</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">median_sobol_indices</span><span class="p">,</span> <span class="n">q1_sobol_indices</span><span class="p">,</span>
        <span class="n">q3_sobol_indices</span><span class="p">,</span> <span class="n">min_sobol_indices</span><span class="p">,</span> <span class="n">max_sobol_indices</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">im0</span><span class="p">,</span> <span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">],</span> <span class="n">axs</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 National Technology &amp; Engineering Solutions of Sandia, LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>